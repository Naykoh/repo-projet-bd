
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>src.models.train_model &#8212; Home Credit Risk Classification  documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for src.models.train_model</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    train_model.py</span>
<span class="sd">    ----------------</span>

<span class="sd">    :param model: &#39;xgb&#39;, &#39;rf&#39; or &#39;gb&#39;</span>
<span class="sd">    :type model: String</span>

<span class="sd">    This package contains function to train 3 differents models, store them locally and on mlflow</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urlparse</span>

<span class="kn">import</span> <span class="nn">mlflow</span>
<span class="kn">import</span> <span class="nn">mlflow.sklearn</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">GradientBoostingClassifier</span><span class="p">,</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="p">(</span><span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">GridSearchCV</span><span class="p">,</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">from</span> <span class="nn">src.features.build_features</span> <span class="kn">import</span> <span class="n">get_features</span><span class="p">,</span> <span class="n">preprocessor_create</span>
<span class="kn">from</span> <span class="nn">varname</span> <span class="kn">import</span> <span class="n">nameof</span>
<span class="c1"># Algorithms, from the easiest to the hardest to intepret.r</span>
<span class="kn">from</span> <span class="nn">xgboost.sklearn</span> <span class="kn">import</span> <span class="n">XGBClassifier</span>

<span class="n">ROOT</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>


<span class="k">if</span> <span class="s1">&#39;{{ cookiecutter.python_interpreter }}&#39;</span> <span class="o">==</span> <span class="s1">&#39;python3&#39;</span><span class="p">:</span>
    <span class="n">PROTOCOL</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">DEFAULT_PROTOCOL</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">PROTOCOL</span> <span class="o">=</span> <span class="mi">2</span>



<div class="viewcode-block" id="fetch_processed"><a class="viewcode-back" href="../../../src.models.html#src.models.train_model.fetch_processed">[docs]</a><span class="k">def</span> <span class="nf">fetch_processed</span><span class="p">(</span><span class="n">data_path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        fetch the data that was processed in make data and create training and test sets</span>

<span class="sd">        :param data_path: location of the dataset</span>
<span class="sd">        :type data_path: String</span>

<span class="sd">        :return: training and test sets</span>
<span class="sd">        :rtype: 2 DataFrame, 2 List</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">app_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">ROOT</span> <span class="o">/</span> <span class="n">data_path</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">app_train</span><span class="p">[</span><span class="s2">&quot;TARGET&quot;</span><span class="p">]</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">app_train</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;TARGET&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Create training and test sets</span>
    <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=.</span><span class="mi">3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span></div>




<div class="viewcode-block" id="model_definition"><a class="viewcode-back" href="../../../src.models.html#src.models.train_model.model_definition">[docs]</a><span class="k">def</span> <span class="nf">model_definition</span><span class="p">(</span><span class="n">preprocessor</span><span class="p">,</span> <span class="n">app_train</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">         define the 3 ML model, XGBoost Classifier, Random Forest Classifier, Gradient Boosting</span>

<span class="sd">         :param preprocessor: ColumnTransformer to handle onehotencoding</span>
<span class="sd">         :type preprocessor: ColumnTransformer</span>

<span class="sd">         :param app_train: need the y.mean() to add a scale_pos_weight to make it balanced</span>

<span class="sd">         :return: 3 models of ML</span>
<span class="sd">         :rtype: XGBClassifier, RandomForestClassifier, GradientBoostingClassifier</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">app_train</span><span class="p">[</span><span class="s2">&quot;TARGET&quot;</span><span class="p">]</span>
    <span class="c1"># XGBoost</span>
    <span class="n">xgb_model</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([(</span><span class="s2">&quot;preprocessor&quot;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="c1"># Add a scale_pos_weight to make it balanced</span>
    <span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">XGBClassifier</span><span class="p">(</span><span class="n">scale_pos_weight</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y</span><span class="o">.</span><span class="n">mean</span><span class="p">()),</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">))])</span>

    <span class="c1"># Random Forest</span>
    <span class="n">rf_model</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([(</span><span class="s2">&quot;preprocessor&quot;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">class_weight</span><span class="o">=</span><span class="s2">&quot;balanced&quot;</span><span class="p">,</span> <span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">))])</span>

    <span class="c1">#GradientBoostingClassifier</span>
    <span class="n">gb_model</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([(</span><span class="s2">&quot;preprocessor&quot;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">GradientBoostingClassifier</span><span class="p">())])</span>

    <span class="k">return</span> <span class="n">xgb_model</span><span class="p">,</span> <span class="n">rf_model</span><span class="p">,</span> <span class="n">gb_model</span></div>


<div class="viewcode-block" id="xgb_fit_model"><a class="viewcode-back" href="../../../src.models.html#src.models.train_model.xgb_fit_model">[docs]</a><span class="k">def</span> <span class="nf">xgb_fit_model</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">xgb_model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        fit a xgb model to the training data</span>

<span class="sd">        :param X_train: data used to train the model</span>
<span class="sd">        :type X_train: DataFrame</span>

<span class="sd">        :param y_train: target feature</span>
<span class="sd">        :type y_train: List</span>

<span class="sd">        :param xgb_model: XGBClassifier model</span>
<span class="sd">        :type xgb_model: XGBClassifier</span>

<span class="sd">        :return: XGBClassifier fitted with gridsearchCV</span>
<span class="sd">        :rtype: XGBClassifier</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gs</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">xgb_model</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;model__max_depth&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span>
    <span class="s2">&quot;model__min_child_weight&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span>
    <span class="s2">&quot;model__n_estimators&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">25</span><span class="p">]},</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="s2">&quot;accuracy&quot;</span><span class="p">)</span>
    <span class="n">gs</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">gs</span><span class="o">.</span><span class="n">best_params_</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">gs</span><span class="o">.</span><span class="n">best_score_</span><span class="p">)</span>

    <span class="n">xgb_model</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span><span class="o">**</span><span class="n">gs</span><span class="o">.</span><span class="n">best_params_</span><span class="p">)</span>
    <span class="n">xgb_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">xgb_model</span></div>

<div class="viewcode-block" id="rf_fit_model"><a class="viewcode-back" href="../../../src.models.html#src.models.train_model.rf_fit_model">[docs]</a><span class="k">def</span> <span class="nf">rf_fit_model</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">rf_model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        fit a random forest model to the training data</span>

<span class="sd">        :param X_train: data used to train the model</span>
<span class="sd">        :type X_train: DataFrame</span>

<span class="sd">        :param y_train: target feature</span>
<span class="sd">        :type y_train: List</span>

<span class="sd">        :param rf_model: RandomForestClassifier model</span>
<span class="sd">        :type rf_model: RandomForestClassifier</span>
<span class="sd">        </span>

<span class="sd">        :return: RandomForestClassifier fitted with gridsearchCV</span>
<span class="sd">        :rtype: RandomForestClassifier</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gs</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">rf_model</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;model__max_depth&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">],</span>
    <span class="s2">&quot;model__min_samples_split&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">]},</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="s2">&quot;accuracy&quot;</span><span class="p">)</span>
    <span class="n">gs</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">gs</span><span class="o">.</span><span class="n">best_params_</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">gs</span><span class="o">.</span><span class="n">best_score_</span><span class="p">)</span>

    <span class="n">rf_model</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span><span class="o">**</span><span class="n">gs</span><span class="o">.</span><span class="n">best_params_</span><span class="p">)</span>
    <span class="n">rf_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rf_model</span></div>


<div class="viewcode-block" id="gb_fit_model"><a class="viewcode-back" href="../../../src.models.html#src.models.train_model.gb_fit_model">[docs]</a><span class="k">def</span> <span class="nf">gb_fit_model</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">gb_model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        fit a gradient boosting model to the training data</span>

<span class="sd">        :param X_train: data used to train the model</span>
<span class="sd">        :type X_train: DataFrame</span>

<span class="sd">        :param y_train: target feature</span>
<span class="sd">        :type y_train: List</span>

<span class="sd">        :param gb_model: GradientBoostingClassifier model</span>
<span class="sd">        :type gb_model: GradientBoostingClassifier</span>

<span class="sd">        :return: GradientBoostingClassifier fitted with gridsearchCV</span>
<span class="sd">        :rtype: GradientBoostingClassifier</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gs</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">gb_model</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;model__max_depth&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">],</span>
    <span class="s2">&quot;model__min_samples_split&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">]},</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="s2">&quot;accuracy&quot;</span><span class="p">)</span>
    <span class="n">gs</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">gs</span><span class="o">.</span><span class="n">best_params_</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">gs</span><span class="o">.</span><span class="n">best_score_</span><span class="p">)</span>

    <span class="n">gb_model</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span><span class="o">**</span><span class="n">gs</span><span class="o">.</span><span class="n">best_params_</span><span class="p">)</span>
    <span class="n">gb_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">gb_model</span></div>

<div class="viewcode-block" id="eval_metrics"><a class="viewcode-back" href="../../../src.models.html#src.models.train_model.eval_metrics">[docs]</a><span class="k">def</span> <span class="nf">eval_metrics</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span><span class="n">loaded_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        compare prediciton and actual value with different metrics to check the accuracy of the model</span>

<span class="sd">        :param actual: Actual value of the target feature of test set</span>
<span class="sd">        :type actual: List</span>

<span class="sd">        :param pred: Predictions of the target feature using the test set</span>
<span class="sd">        :type pred: List</span>

<span class="sd">        :param loaded_model: model selected to check the metrics</span>
<span class="sd">        :param X_test: useful to calculate auc score</span>

<span class="sd">        :return: auc, recall, precision, f1, matrix</span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="n">auc</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">actual</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> <span class="n">loaded_model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">])</span>

    <span class="n">recall</span><span class="o">=</span><span class="n">recall_score</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span><span class="n">pred</span><span class="p">)</span>
    <span class="n">precision</span><span class="o">=</span><span class="n">precision_score</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span><span class="n">pred</span><span class="p">)</span>
    <span class="n">f1</span><span class="o">=</span><span class="n">f1_score</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span><span class="n">pred</span><span class="p">)</span>

    <span class="n">matrix</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span><span class="n">pred</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">auc</span><span class="p">,</span> <span class="n">recall</span><span class="p">,</span> <span class="n">precision</span><span class="p">,</span> <span class="n">f1</span><span class="p">,</span> <span class="n">matrix</span></div>


<div class="viewcode-block" id="mlflow_train"><a class="viewcode-back" href="../../../src.models.html#src.models.train_model.mlflow_train">[docs]</a><span class="k">def</span> <span class="nf">mlflow_train</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">X_train</span><span class="p">,</span><span class="n">y_train</span><span class="p">,</span><span class="n">X_test</span><span class="p">,</span><span class="n">y_test</span><span class="p">,</span><span class="n">fit_function</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Fit the model and evaluate the accuracy of the model, model and metrics are saved on mlflow</span>

<span class="sd">        :param model: Model selected</span>

<span class="sd">        :type X_train: DataFrame</span>

<span class="sd">        :type y_train: List</span>

<span class="sd">        :type X_test: DataFrame</span>

<span class="sd">        :type y_test: List</span>

<span class="sd">        :param fit_function: fit function depending on the selected model</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_run</span><span class="p">():</span>

        <span class="c1">#Train the model</span>
        <span class="n">model_fitted</span> <span class="o">=</span> <span class="n">fit_function</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>

        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">model_fitted</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

        <span class="p">(</span><span class="n">auc</span><span class="p">,</span> <span class="n">recall</span><span class="p">,</span> <span class="n">precision</span><span class="p">,</span> <span class="n">f1</span><span class="p">,</span> <span class="n">matrix</span><span class="p">)</span> <span class="o">=</span> <span class="n">eval_metrics</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span><span class="n">model_fitted</span><span class="p">,</span> <span class="n">X_test</span><span class="p">)</span>


        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  auc: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">auc</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  recall: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">recall</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  precision: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">precision</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  F1 score: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">f1</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  matrix: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">matrix</span><span class="p">)</span>


        <span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="s2">&quot;params&quot;</span><span class="p">,</span> <span class="n">model_fitted</span><span class="o">.</span><span class="n">get_params</span><span class="p">()[</span><span class="s1">&#39;model&#39;</span><span class="p">])</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span><span class="s2">&quot;auc&quot;</span><span class="p">,</span> <span class="n">auc</span><span class="p">)</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span><span class="s2">&quot;recall&quot;</span><span class="p">,</span> <span class="n">recall</span><span class="p">)</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span><span class="s2">&quot;precision&quot;</span><span class="p">,</span> <span class="n">precision</span><span class="p">)</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span><span class="s2">&quot;F1 score&quot;</span><span class="p">,</span> <span class="n">f1</span><span class="p">)</span>


        <span class="n">tracking_url_type_store</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">mlflow</span><span class="o">.</span><span class="n">get_tracking_uri</span><span class="p">())</span><span class="o">.</span><span class="n">scheme</span>
        <span class="c1"># Model registry does not work with file store</span>
        <span class="k">if</span> <span class="n">tracking_url_type_store</span> <span class="o">!=</span> <span class="s2">&quot;file&quot;</span><span class="p">:</span>

            <span class="c1"># Register the model</span>
            <span class="c1"># There are other ways to use the Model Registry, which depends on the use case,</span>
            <span class="c1"># please refer to the doc for more information:</span>
            <span class="c1"># https://mlflow.org/docs/latest/model-registry.html#api-workflow</span>
            <span class="n">mlflow</span><span class="o">.</span><span class="n">sklearn</span><span class="o">.</span><span class="n">log_model</span><span class="p">(</span><span class="n">model_fitted</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">registered_model_name</span><span class="o">=</span><span class="n">nameof</span><span class="p">(</span><span class="n">fit_function</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mlflow</span><span class="o">.</span><span class="n">sklearn</span><span class="o">.</span><span class="n">log_model</span><span class="p">(</span><span class="n">model_fitted</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">)</span></div>






<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../../src.models.html#src.models.train_model.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Trains the model and test their accuracy on the retrieved data write it back to file and store the trained model</span>

<span class="sd">        :param model: model selected</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#Define the 3 model</span>
    <span class="n">app_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">ROOT</span><span class="o">/</span><span class="s2">&quot;data/processed/app_train_processed.csv&quot;</span><span class="p">)</span>
    <span class="n">num_features</span><span class="p">,</span> <span class="n">cat_features</span> <span class="o">=</span> <span class="n">get_features</span><span class="p">(</span><span class="n">app_train</span><span class="p">)</span>
    <span class="n">preprocessor</span> <span class="o">=</span> <span class="n">preprocessor_create</span><span class="p">(</span><span class="n">num_features</span><span class="p">,</span> <span class="n">cat_features</span><span class="p">)</span>
    <span class="n">xgb_model</span><span class="p">,</span> <span class="n">rf_model</span><span class="p">,</span> <span class="n">gb_model</span> <span class="o">=</span> <span class="n">model_definition</span><span class="p">(</span><span class="n">preprocessor</span><span class="p">,</span> <span class="n">app_train</span><span class="p">)</span>


    <span class="c1">#fetch the processed dataset with training and test set</span>
    <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">fetch_processed</span><span class="p">(</span><span class="s1">&#39;data/processed/app_train_processed.csv&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;xgb&#39;</span><span class="p">):</span>
        <span class="n">mlflow_train</span><span class="p">(</span><span class="n">xgb_model</span><span class="p">,</span><span class="n">X_train</span><span class="p">,</span><span class="n">y_train</span><span class="p">,</span><span class="n">X_test</span><span class="p">,</span><span class="n">y_test</span><span class="p">,</span><span class="n">xgb_fit_model</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;rf&#39;</span><span class="p">):</span>
        <span class="n">mlflow_train</span><span class="p">(</span><span class="n">rf_model</span><span class="p">,</span><span class="n">X_train</span><span class="p">,</span><span class="n">y_train</span><span class="p">,</span><span class="n">X_test</span><span class="p">,</span><span class="n">y_test</span><span class="p">,</span><span class="n">rf_fit_model</span><span class="p">)</span>
    <span class="k">else</span> <span class="p">:</span>
        <span class="n">mlflow_train</span><span class="p">(</span><span class="n">gb_model</span><span class="p">,</span><span class="n">X_train</span><span class="p">,</span><span class="n">y_train</span><span class="p">,</span><span class="n">X_test</span><span class="p">,</span><span class="n">y_test</span><span class="p">,</span><span class="n">gb_fit_model</span><span class="p">)</span>



    <span class="c1"># Store model and test set for prediction</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;xgb&#39;</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ROOT</span> <span class="o">/</span> <span class="s1">&#39;models/xgb_model.model&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fout</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">xgb_model</span><span class="p">,</span> <span class="n">fout</span><span class="p">,</span> <span class="n">PROTOCOL</span><span class="p">)</span>  
    <span class="k">elif</span> <span class="p">(</span><span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;rf&#39;</span><span class="p">):</span>   
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ROOT</span> <span class="o">/</span> <span class="s1">&#39;models/rf_model.model&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fout</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">rf_model</span><span class="p">,</span> <span class="n">fout</span><span class="p">,</span> <span class="n">PROTOCOL</span><span class="p">)</span>
    <span class="k">else</span> <span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ROOT</span> <span class="o">/</span> <span class="s1">&#39;models/gb_model.model&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fout</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">gb_model</span><span class="p">,</span> <span class="n">fout</span><span class="p">,</span> <span class="n">PROTOCOL</span><span class="p">)</span>


    <span class="n">X_test</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">ROOT</span> <span class="o">/</span> <span class="s1">&#39;data/processed/app_train_x_test.csv&#39;</span><span class="p">,</span>
        <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">y_test</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">ROOT</span> <span class="o">/</span> <span class="s1">&#39;data/processed/app_train_y_test.csv&#39;</span><span class="p">,</span>
        <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
   
    <span class="n">model</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">model</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    
    <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">model</span> <span class="o">!=</span> <span class="s1">&#39;xgb&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">model</span><span class="o">!=</span> <span class="s1">&#39;rf&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">model</span> <span class="o">!=</span> <span class="s1">&#39;gb&#39;</span><span class="p">))</span> <span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;unknown model, pass a model in argument among xgb, rf and gb&#39;</span><span class="p">)</span>

    <span class="n">main</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">Home Credit Risk Classification</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, Nayel HAMANI, Karthikeyan PAVADE.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.2.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>